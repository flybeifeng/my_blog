---
title: AppsFlyer踩坑记
date: 2016-10-22 21:28:06
categories: android踩坑笔记
---
#### 起因
上周，公司另一个团队的应用接入了我们的sdk之后，AppsFlyer后台统计的买量用户数据与他们应用自己统计的买量用户数据不匹配（自己统计的近似为零）<!-- more -->，那边排查了一会之后把问题抛给了我们的sdk，作为一个**合格**的程序猿，接到bug反馈的第一反应就是：我的代码怎么可能有问题？会不会是你统计错了，会不会是AppsFlyer自己出了问题blablabal...并把问题反抛回去，然而尴尬的是，对方把我们的sdk去掉之后，统计数据又正常了（脸好疼）...

#### 发展
好吧，出了问题得排查啊，奈何本人又有作为一个**合格**程序猿必备属性--沟通障碍，而且我们sdk只是初期阶段，代码实在简单，看不出任何问题所在，于是两天时间过去了，问题没有任何进展，可是问题没有进展对对方没有任何影响，却影响了我们自己的sdk对外推广。第三天早上，主管看不下去了，在他的带领下，与对方的研发开了个会，最终把问题定位到五个点
- 1、应用上传到AppsFlyer的sdk
- 2、AppsFlyer的sdk内部处理数据
- 3、AppsFlyer的sdk返回数据到应用
- 4、应用接收到AppsFlyer的数据并且解析
- 5、应用把解析结果上传到自己的服务器

问题定位到以上五个点，对方负责在这五个点打log（AppsFlyer的sdk的log可以自己打开）并出一个有接sdk一个没接sdk的包。然后测试负责对比两个包的log打印情况。

#### 再发展
第四天下午（没错，他们第三天下午要出新版本，没时间给我们打包，而且第三天因为加班比较晚，第四天白天休息）对方的开发把包发给了测试，五分钟后（就是这么快...）问题定位到了第三点，同样的操作下AppsFlyer返回的数据居然不一样，其实也就是第二点，AppsFlyer内部处理数据出问题了，而且是我们的sdk影响的（真是见鬼了...）

#### 找到问题
AppsFlyer的sdk出了问题，没办法，只能看其源码了，定位到返回数据的部分，果然带sdk的应用AppsFlyer的sdk向其后台发送请求时url的路径多了个200，导致返回的数据不一样，这200哪里来的呢？确实是我们的sdk带来的，我们要求接入sdk的应用都要在清单文件（AndroidManifest.xml）上配一个渠道号，而渠道的name：**CHANNEL**,然而AppsFlyer在拼接url的时候也会去读这个**CHANNEL**存在就带到url去，如果不存在就返回**""** ，这点AppsFlyer也没有特殊说明，他们也不知道AppsFlyer要配这个CHANNEL,于是悲剧就发生了...

#### 总结
本来是一个很简单的问题，如果只是在一个应用内部，估计几分钟就排查出问题了，结果拖了我们快一周的时间，也暴露了几个问题：
- 要主动与人沟通，拖延解决不了任何问题
- 对于一些公共资源，要添加自己的特殊标识
- 抛给你的问题，不用急着往外抛，不然会被打脸

                              ———— 以上，记一次踩坑

不说了，我要去给脸消消肿了...
